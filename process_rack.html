<!DOCTYPE html>
<html>

<body>
    <img id="img" src="/rack.png" crossorigin="anonymous">
    <canvas id="canvas"></canvas>
    <textarea id="output"></textarea>
    <div id="status">Processing...</div>
    <script>
        const img = document.getElementById('img');
        img.onload = () => {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const w = img.naturalWidth;
            const h = img.naturalHeight;
            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, w, h);
            const data = imageData.data;

            // Sample background color from top-left
            const bgR = data[0];
            const bgG = data[1];
            const bgB = data[2];
            const threshold = 30; // Tolerance for background removal

            let minX = w, minY = h, maxX = 0, maxY = 0;
            let found = false;

            // 1. Remove Background & Find Bounds
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const i = (y * w + x) * 4;
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    const dist = Math.sqrt(
                        Math.pow(r - bgR, 2) +
                        Math.pow(g - bgG, 2) +
                        Math.pow(b - bgB, 2)
                    );

                    if (dist < threshold) {
                        data[i + 3] = 0; // Make transparent
                    } else {
                        // Updated bounding box
                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;
                        found = true;
                    }
                }
            }

            if (!found) {
                document.getElementById('status').innerText = "ERROR: Empty Image";
                return;
            }

            // 2. Crop
            const cropW = maxX - minX + 1;
            const cropH = maxY - minY + 1;

            const croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = cropW;
            croppedCanvas.height = cropH;
            const croppedCtx = croppedCanvas.getContext('2d');

            // Put the modified data (transparency applied) back to original canvas first
            ctx.putImageData(imageData, 0, 0);

            // Draw the relevant slice to the new canvas
            croppedCtx.drawImage(canvas, minX, minY, cropW, cropH, 0, 0, cropW, cropH);

            const dataURL = croppedCanvas.toDataURL('image/png');
            const base64 = dataURL.split(',')[1];

            document.getElementById('output').value = base64;
            document.getElementById('status').innerText = "DONE";
        };
    </script>
</body>

</html>